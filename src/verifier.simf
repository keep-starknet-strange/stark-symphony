// SPDX-FileCopyrightText: 2025 StarkWare Industries Ltd.
//
// SPDX-License-Identifier: MIT

//! STARK verifier for the Fibonacci squared AIR.

#include "channel.simf"
#include "fri.simf"
#include "air.simf"
#include "field.simf"

/// STARK proof for the Fibonacci squared AIR.
/// - Merkle root of the trace polynomial evaluation on extended domain
/// - Evaluations of the trace polynomials in the sampled point, together with the corresponding Merkle proofs.
/// - FRI decommitments
/// - Last FRI layer: Merkle root and free term
type FibSquareProof = (u256, FibSquareEvals, List<FriLayer, 32>, FriLastLayer);

/// Evaluation of the trace polynomial in a given point, together with the corresponding Merkle proof.
type Eval = (u32, MerkleProof32);

/// Verify the proof that we know A_1 such that the Fibonacci squared sequence is correct and has
/// the following boundaries: A_0 == 1, A_1022 == 2338775057.
fn verify_proof(proof: FibSquareProof) {
    let (p_mt_root, evals, fri_layers, last_layer): FibSquareProof = proof;
    // Read Merkle root of the trace polynomial evaluation on extended domain
    let state: ChannelState = sha256(p_mt_root);
    // Read composition polynomial coefficients
    let (state, coeffs): (ChannelState, FibSquareCoeffs) = fibsquare_read_coefficients(state);
    // Read FRI commitments
    let state: ChannelState = fri_read_commitments_32(fri_layers, last_layer, state);
    // Random query
    let (state, idx): (ChannelState, u32) = channel_draw_32(state, DOMAIN_EX_SIZE);
    // Read trace polynomial evaluations in specified point
    let state: ChannelState = fibsquare_read_evaluations_checked(state, evals, idx, p_mt_root);
    // Calculate x given the random query
    let x: u32 = fibsquare_calc_x(idx);
    // Evaluate composition polynomial
    let cp_ev: u32 = fibsquare_compose(x, coeffs, evals);
    // Verify FRI layers
    fri_verify_32(fri_layers, last_layer, idx, x, cp_ev);
}

fn test_verifier() {
    let proof: FibSquareProof = (
        104500214297066916133126671825692285761566746556879834723302550549120383229768,
        (
            (
                1553385321,
                list![
                    59296463130098810404182539947756390286632030648216907658180739736373671492693,
                    35835921023109093912162581095500541506245523212856808940001919509147024199793,
                    75362496031006777625831087844481896429142178830709924805805027478532971879024,
                    38635009913183953298579881371599026045736080308918783000256093992799297760217,
                    101768046683323354971157647620578926013863970561703323846807196325776007013485,
                    102222855115090656259497637378206969818823455231218029925675573971513015713423,
                    58845432133187862321253970502747040293111466464161950327641002038719917072864,
                    113503476469932192722474452851445981286314151615953501392434858031987142980104,
                    31571385272079568647737417989455996606107655769106167974388812340998655651545,
                    51634070432680724042143871732701449776592056817821288235959425740742974388283,
                    61329506687052594631433328070272101981438441623188337627073414536024127849073,
                    68599396864515883651939550638527607595242626780681277342646949156789742939178,
                    56974666195930694403713290580441264812544914556973432228768127355537336583012
                ],
            ),
            (
                741268018,
                list![
                    71532058974461322363650449043086026277131424577273245696767972341227706697428,
                    24244297283508280507632849842309844267396141736521155409413321453902048183402,
                    61924022857932665832874719999961553743586446434669638756867639186546501363623,
                    32362060083179244259449412204771726347008745655196483182591924991262769678828,
                    101768046683323354971157647620578926013863970561703323846807196325776007013485,
                    102222855115090656259497637378206969818823455231218029925675573971513015713423,
                    58845432133187862321253970502747040293111466464161950327641002038719917072864,
                    113503476469932192722474452851445981286314151615953501392434858031987142980104,
                    31571385272079568647737417989455996606107655769106167974388812340998655651545,
                    51634070432680724042143871732701449776592056817821288235959425740742974388283,
                    61329506687052594631433328070272101981438441623188337627073414536024127849073,
                    68599396864515883651939550638527607595242626780681277342646949156789742939178,
                    56974666195930694403713290580441264812544914556973432228768127355537336583012
                ],
            ),
            (
                3157962,
                list![
                    66754839643303000492500169335613873871972079962865828777145645174693052978491,
                    114290022389461905957773812581285038086779586174425774777048484410824243561068,
                    28628741838060214802221103670349737408363298752478974115363405621693908887038,
                    60895365172458460407119155225389518208564552940028960167567821559293894440113,
                    26028888084730723780599774104907887866817375056093691506977680358168656703678,
                    102222855115090656259497637378206969818823455231218029925675573971513015713423,
                    58845432133187862321253970502747040293111466464161950327641002038719917072864,
                    113503476469932192722474452851445981286314151615953501392434858031987142980104,
                    31571385272079568647737417989455996606107655769106167974388812340998655651545,
                    51634070432680724042143871732701449776592056817821288235959425740742974388283,
                    61329506687052594631433328070272101981438441623188337627073414536024127849073,
                    68599396864515883651939550638527607595242626780681277342646949156789742939178,
                    56974666195930694403713290580441264812544914556973432228768127355537336583012
                ],
            ),
        ),
        list![
            
            (
                111946434827258922207533214337541842175192226593200877216295834618633792652802,
                593409582,
                1368740410,
                list![
                    109466542910029703203348968147694827421118166457642965434697087935199318165339,
                    59223873866475952612235485076039772436057911644979249173057830457895265013123,
                    98521969228050292518192722471616690104097687203261988011951188711345409721385,
                    4253822277849032760848636215883352526476411542492886356533741433514144274186,
                    7091270776688316362985733214661425104565370271334332193957336326918149950015,
                    51623868798371751086589040035189079099478543247624017809669348566684388511457,
                    60730772859499541769601149213506950436217103478324870739468043864977484131110,
                    72199597148775060007804391688618310969172317490329707488205277575896024223563,
                    34332515623686561753550170828207317997786802468727216321959822650070563704421,
                    12097769478448150589327321570418169994979131581393177625641417587046959337394,
                    39719471584695492611305100505532341571505339430366331074551573077818051147907,
                    42116764288072310070672189276989507429562415039346819313514627634725942212400,
                    73532842762720789267106903508676014702951899518336472895610872065937466577305
                ],
                2371253244,
                list![
                    84993286456095409418426086727967054793005661140297905476287694130741526161160,
                    61173016942105136110578784162632010350058191737293555703739211918867512524480,
                    83679009699181999437109536140431770736043385133832240642894959483490124326883,
                    113682924527744522357358684272651293239748720632180280348324122421004687386789,
                    41563014459070246026942001013721944513403320396969045016562615556594922131626,
                    4606067000229706063870890508312316776209186007985427364060751347056084747356,
                    61105852836606040196738042121137340279127676408802132189083722322597958439963,
                    80099344639492597919626974003312459771057880268990875958068896853591824457242,
                    36497890823230623063184453614082461972695600688295242579096849817626365662044,
                    111853446853765802270067145146300697404523959432380304243755511768515207675731,
                    104940720110034263679791376384419227032840120631868079654204910575613198178613,
                    21943457295434020271389422071548966147606711680691687391960551525548151490561,
                    108116531307910424503647974058998454900889561312254412332578839325377658707085
                ],
            ),
                
            (
                14609411070256597378387532347992493223023351766135098876668934012071487472382,
                1838972885,
                257677004,
                list![
                    46364872661379903935138934860848066116186513410812407180059839322307486658680,
                    12997577066556112074247919837159036707522062380678775371394244333163901584510,
                    53579990406046926712429546016211463818323043616649247665150804029968188450581,
                    20741534998667770401572255059588348944020627515554741192403630652400605243540,
                    98762940915031453646351069370635319980244729837917676203359122413427489523837,
                    105533454425163007536140547110093104172650239524328560901796462280078243300857,
                    99173112030806120571678319254516476590987054929236043962304941397337650375676,
                    77792053133153754807775450518363305635480518642972036935092375370568456851693,
                    56446570297813414604224333769134888711702042968950081868180986298289985423989,
                    15745707818781224367795079974498957740956737896687286834299487116594507034856,
                    94567510174312244805772266057667402266438602144916324326027180124051249110240,
                    102146779539805947974236504967555713059736195542450178174944570957989705723401
                ],
                2381434089,
                list![
                    78664434983439139548538575718112035762772001961271711402895982985432177084442,
                    23868813825400438760348992623019039055841093449462042731375132185040046839674,
                    31780044755666814817784242829284939342591398084697534439365836459728295630823,
                    101972842892887106992700073645847535045064426667742750841615491578614892442198,
                    27277777071547725256334153926403010947705049763046798049056237325537180443098,
                    18839892185675829068722514719470846672587185298931324975588431187792134811366,
                    105477457362356955973155666180431301339871251148037475161768316357587222804601,
                    64135946213347259433060724397807217480776337831157038750349477587367889620860,
                    49293808868388608545713959781931712171793104646955247080301798995392282746859,
                    39053649629290453689985682564850422958582943764412462156288260418008055710520,
                    115399644493171152917090505276330310697875946258994975267467743193896994141225,
                    100386306058649164977898107900012791789522270657328832254866212677131141143646
                ],
            ),
                
            (
                16187237833258614573159264045276350661232941951731651418567972740608421874183,
                720845053,
                498109636,
                list![
                    69130276206313901752049983901836846686836039792346861010214266058364557964719,
                    105261052020289012516786157493010551557542702149527797847024439146295255756995,
                    27172766938344833573890921908989517918376784222106197619473055754224167355005,
                    41096276848479292714631527545780989809177466392440008776777763497024902143868,
                    82411053462260461476933525432093761302515469370529710006146803062733459146926,
                    75133672980360624221952212832217491039483286737063898312471551709590276376249,
                    9897659831069392572842051965187946611543903002308542432545613275746773483131,
                    50178830629435889634072205285392993966641290371896520243733820422822672693916,
                    39086761945724894944207793713091466067486216458417841379145915101564195900522,
                    72571663422008367742932549000377817540790117690744744773290045344218226647588,
                    12764200682137467477510613160967531054197068385553155047372517506302699406566
                ],
                69160168,
                list![
                    53350154687149327443529727480365462032787312475195695779034440444803573747164,
                    29592159826046785831477117268116356224729314024512018293248050466037004501846,
                    51774922974204204433257802664751649662316530183495469147176816211115118568377,
                    61421484638594801200280893074486646158198570828546319263372815953118933274107,
                    83602811229610875554171197502918827930064622440947875787200713530750165234658,
                    77004970257000174907183032323159019866278738926756435928455920515362169193729,
                    93647522747449229885637034078224578732593569750496050937053994018071868454709,
                    86201319808137295438105254647550539935227589866752717019959841719876982579495,
                    92192275598347968019343088439084223704628008983059781451446698408653905242412,
                    93926359487218491953541041835733492295592655348248164932048318416276100941195,
                    69648837543493228761353596820873427850318265928400066921816467739657143210617
                ],
            ),
                
            (
                73544147395337689004430467629315209559681614627067346301810556415192743581500,
                1755652062,
                1046368226,
                list![
                    30619613555290040819773888367960778271908574644037648484421534491898328307119,
                    53319932607527644526733444367179947754635390539284780440550619268579495488190,
                    39374041218882044492753805769879802687919052739364952892099124470912005527241,
                    65864553532149499298160656517082011154246027749131894800137543575019074491502,
                    24269466424403082029117328735473423705044012954352096839579040256837389337268,
                    22690155839541219580864774247466785935064065952299128328110576672426643167541,
                    105817038513574285744119432465575847887203675656418558933495533684015566234703,
                    49014735263717969391160630102647819739920469532758687075797943124049176163890,
                    3106396235451546678333456011344047220303822244430415407434439065471443391006,
                    89425822023787115004997529614203966725509035503824782859167290849363318923711
                ],
                1832479897,
                list![
                    89322480982524059156454945829067419139859157930530903937965702220970863746496,
                    77376475647854407207420028814530129726332572357999247993309615256718147773387,
                    93425116954044448078043686669914433787084138765413933564213199543279700741109,
                    8630281362778956011030937521826878461290711744963414680530108464174098770983,
                    62990415179278473914910917113944249463443922548010024641119916025938076372775,
                    101808658226620629650356988101950654690782720253045799255943272053397763827362,
                    87312013648810993738063722839258645269617093995950571748182275700104533480076,
                    97938820191726658702117269462663470956085821650391780994433865031611505296722,
                    51858889079961886084377384029917755555028680842564365541217251737794697113484,
                    70025665468674581662679866329236654680448349358128881261637621466176617333405
                ],
            ),
                
            (
                15724229312219948954954512583504467882983404941165832610262898233590117033594,
                1994040583,
                961858558,
                list![
                    68600967525976607449413463203009361568858795471953066377774668295363077336287,
                    78274094619714313698631284005912314700435890179980051223511976595716383297154,
                    61628677235511021151275663013738753179866956455575147845523373720406818483075,
                    30107774480567825427055362043586987967027386540671188589799726173406317369414,
                    43396185411046872510133492349484954192484049049851857648375323943511776929951,
                    81848701916636258560872537429008250133865717430571566930653237497894727735622,
                    41228584614316032976895809718437489158952140278181001098793534957609457333349,
                    2639315109910503020876975599521892511816191183584891236269609268687696561294,
                    107760691204997306998719828293681288190450186649764277291571152238428551135897
                ],
                919393395,
                list![
                    20492541317564465935869167630343544983929361238925852209034821637593733026971,
                    32119637734709737522520637416876811252255137465839720315600082742994059135089,
                    76297866166754907934106019475616026750349338897561755421439253159094624118600,
                    108381392427427402674823336094912030666006594891653405182116428409024043266146,
                    57008585856313181770286175578597867917984460072907640171957339128791302326178,
                    78127940862661032893140644791992901051992101464899314131264797902201368201485,
                    38175389610248119404303309751548453291559859914666765712809322175917236454783,
                    6268028930003591082046005795017276593383134983163549078755775694769548882466,
                    83677109099360921584226154686720249543501031701562006319680595592535157104619
                ],
            ),
                
            (
                17738437910730036923927185422057906728211125170085170242151265136234594255630,
                1151636718,
                2771716459,
                list![
                    107312071012883164266216609283361048163309302186281370794418819246529638420324,
                    37295673001948580872228191204747359651293264233606318294995826524949257521301,
                    82915747199834369635628921107315892599426151140895008746921585096324469914137,
                    115515411187648788699977528424638521746092978545086181214689958265034590795778,
                    103153017905885118655599651517861301695563404660099542481274566360734836652131,
                    22142482604963710311826435893530117001946299326850327090073395969718253584865,
                    51713619779655332107569403913051352623015115147843660938286841368454181037343,
                    109494186093398839053966362934132388865504790358380231206661027898967232968414
                ],
                1993619015,
                list![
                    88008293195730137135653266040738137415193385116689373023958650170284614571404,
                    5931686335232496204567266135536219800296890214575296314918903984018319470237,
                    85789364594590048348285138438940664521841924466110569307715163502518551773798,
                    28164925532875036287587345840929516082632936415615520070365270775970145815897,
                    19215252925937602591062850010176904672547193525486733806450479646311005508369,
                    85184083734978219537975343421160612156687734889046534461108783434824979505194,
                    88018235343773427471995655888229641676849184989192642912724466548299125222491,
                    82302166834912850032824134185356574441529042942116214962854850446485106909922
                ],
            ),
                
            (
                45414240831122634981114974407216132319985725114217189998139454326440586470300,
                2350631655,
                2118272773,
                list![
                    102577390581846501960628647891353577845960398368227429998996167913649348578327,
                    71114863479294437223329289358504476474633738109504904705787047056872315309022,
                    82692454010771863532169329366295800900145666008657550361292766618071476263701,
                    22613143449138064909938836614691885099258303874560128907242165400244498943736,
                    84150924573496087170796032344487119162483723554627950584454890665095100672809,
                    101211203829292083810756373568099014512583947761832080912746931289374803503259,
                    22760051107696355366671880377357370286747171747223149559195553311120968888666
                ],
                707378775,
                list![
                    54327167507300207612974893603024031755771485723902258922317720713457924878890,
                    6764650841055483835356074084421403978183784788312183157398542941280887969651,
                    8687603179849011548716878939249557457806256851922730199787033207090744772397,
                    103711886259399623124521450963287444737235942409972387040892061037296942717042,
                    99815964287807442925135557454478665187745583916685039463687050952360516218446,
                    82043432833859917700364219591696309664292344952914371462782656889068365641873,
                    79511809662151950007613518022242223738579466770786727006759777478361557155599
                ],
            ),
                
            (
                86593030678223703421651047821545416377485176882670647333545017246111918712745,
                2438179415,
                575507611,
                list![
                    77704710738413979624445139815058799314193565876750381342403800333166339056968,
                    58352698319418296856012083709041332534783964370501177726943128431617653721983,
                    84407140921452113498587477923358029224062507697174012281313866691004717750958,
                    87501976869121668379576532257872093157772609540927442152866945212133611589843,
                    16928479464306232457685844023604629457984378537995740314611427692128789757910,
                    41400117452279044837254698405379351032900690556019062813943866616947701016076
                ],
                1563490795,
                list![
                    100394781897717164015440666810759041869145490699830231361274034776289430491306,
                    105851401035093847079921873039561366883135661650742371450296933977415868020193,
                    95314581180510702196251494926097606875168415935718675620891988919823980692326,
                    22829148620241184414472228745008552412544648811405761081551159566927956100624,
                    81778823558778029378670561145851328337015370450984626282281987452396742712824,
                    76165052397842229918188138898358370362921459811096809526792798516395294113945
                ],
            ),
                
            (
                81486635216770259806928363191566725559166199191715651782449064474797352482260,
                259430084,
                1641928685,
                list![
                    27615898053415472464425985291862243760409451151300492019321050641479833992357,
                    74141753905672656757662065920336133259188337837138683935920163087629063168224,
                    78382459455299988184746273845884424858500278188602912761903292648764736710878,
                    31254224035190358677171356634830230222511147775138292740077029706583340395839,
                    3531409345126854725106386585806242960815835671510496940623029353855446561638
                ],
                658927437,
                list![
                    19318940360813223581977209796768996452979348645146754350477129892654506558829,
                    19376403568516565604192060120793834028435353213177835927972438890331357312959,
                    77363115410185596117788840398905404025526806334951715468047533986824323058374,
                    46187728818650539637755121459565094307591438867360994468673950832034067552493,
                    58431110636763261638082317470725828768732821109033871250453524437997181558328
                ],
            ),
                
            (
                2602135856068406767876326370940493454803525596065452959785412916693689963469,
                2273092189,
                1251305153,
                list![
                    37594613418733288605919156060969250527957214078046456689711964741118384376351,
                    80964007339239488016279179956691670412044946620023572621687690989305747699468,
                    77871036458790620267354093329136468779664617915568876151297961081025262359837,
                    41055796356862930404048357492327774205021281500772600275213987342857774512496
                ],
                1873445338,
                list![
                    27455750522982303216300236170000759602447422370063584887813657296717309813824,
                    5965164490025877506357645212867106766992722300107955061496272753764679821439,
                    105623462990254858147137603646571540444126514139168133303981262725435984720890,
                    90172877730879475162581330193883411947623444707917800039947910590666800578054
                ],
            )
        ],
        (
            82254079243737864540513136685540892552796163938457282561301990170133914440615,
            2133065320
        )
    );
    verify_proof(proof);
}
