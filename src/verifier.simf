// SPDX-FileCopyrightText: 2025 StarkWare Industries Ltd.
//
// SPDX-License-Identifier: MIT

//! STARK verifier for the Fibonacci squared AIR.

#include "channel.simf"
#include "fri.simf"
#include "air.simf"
#include "field.simf"

/// STARK proof for the Fibonacci squared AIR.
/// - Merkle root of the trace polynomial evaluation on extended domain
/// - Evaluations of the trace polynomials in the sampled point, together with the corresponding Merkle proofs.
/// - FRI decommitments
/// - Last FRI layer: Merkle root and free term
type FibSquareProof = (u256, FibSquareEvals, List<FriLayer, 32>, FriLastLayer);

/// Evaluation of the trace polynomial in a given point, together with the corresponding Merkle proof.
type Eval = (u32, MerkleProof32);

/// Verify the proof that we know A_1 such that the Fibonacci squared sequence is correct and has
/// the following boundaries: A_0 == 1, A_1022 == 2338775057.
fn verify_proof(proof: FibSquareProof) {
    let (p_mt_root, evals, fri_layers, last_layer): FibSquareProof = proof;
    // Read Merkle root of the trace polynomial evaluation on extended domain
    let state: ChannelState = sha256(p_mt_root);
    // Read composition polynomial coefficients
    let (state, coeffs): (ChannelState, FibSquareCoeffs) = fibsquare_read_coefficients(state);
    // Read FRI commitments
    let state: ChannelState = fri_read_commitments_32(fri_layers, last_layer, state);
    // Random query
    let (_, modulo): (bool, u32) = jet::add_32(DOMAIN_EX_SIZE, 1);
    let (state, idx): (ChannelState, u32) = channel_draw_32(state, modulo);
    assert!(jet::eq_32(idx, 365));
    // Read trace polynomial evaluations in specified point
    let state: ChannelState = fibsquare_read_evaluations_checked(state, evals, idx, p_mt_root);
    // Calculate x given the random query
    let x: u32 = fibsquare_calc_x(idx);
    // Evaluate composition polynomial
    let cp_ev: u32 = fibsquare_compose(x, coeffs, evals);
    // Verify FRI layers
    fri_verify_32(fri_layers, last_layer, idx, x, cp_ev);
}

fn test_verifier() {
    let proof: FibSquareProof = (
        104500214297066916133126671825692285761566746556879834723302550549120383229768,
        (
            (
                2915689030,
                list![
                    40002981752987147694309380063602322877192470823891740405244967830358421330165,
                    68230051127233951163966464088993224369415563839403172920771929824688376897836,
                    44367194844377689594601408886911285881450064458724818845992887113201531757121,
                    60552900297880916965024681698561373284576136923986771043513996698868811233985,
                    79218389783070783756683999973685334738468089983346892627711616664675847169649,
                    86056786573167414412681166168252960406880608123124193289687215839010289393365,
                    42453213914905194455440404069578264192574453344270898367924206751883339264593,
                    100519484132498123993280827552597641444767528842124397297226835189343039225855,
                    30418746830344061354082449665096536031982034761593207228745631004087660418979,
                    94840054322059291530750321008166965053871351749658110562305809404250112199706,
                    42301955221152678394190333573390831727995145343891343924222537015244996575494,
                    68599396864515883651939550638527607595242626780681277342646949156789742939178,
                    56974666195930694403713290580441264812544914556973432228768127355537336583012
                ],
            ),
            (
                2938213560,
                list![
                    72288934213593133613443704199548478865306304083372089741092985229346635200723,
                    111824207616634017768626477737407347374033066819829390590454273819887274385267,
                    95386957591322134125778851773456469479030285863002549907776939669807997113175,
                    2589018421366084410075552518006571123417947479060035816380589798187479047656,
                    97738630836122651931907371295696926181303516999085767965275756802769103696640,
                    86056786573167414412681166168252960406880608123124193289687215839010289393365,
                    42453213914905194455440404069578264192574453344270898367924206751883339264593,
                    100519484132498123993280827552597641444767528842124397297226835189343039225855,
                    30418746830344061354082449665096536031982034761593207228745631004087660418979,
                    94840054322059291530750321008166965053871351749658110562305809404250112199706,
                    42301955221152678394190333573390831727995145343891343924222537015244996575494,
                    68599396864515883651939550638527607595242626780681277342646949156789742939178,
                    56974666195930694403713290580441264812544914556973432228768127355537336583012
                ],
            ),
            (
                2430756332,
                list![
                    106483272729973247114202962991936545388170589506808004866945301001253458173861,
                    30436707198469349251376595222460651134574316339633093483328622865215007198962,
                    56378296795646261037801729579376794196927610154472569422126544108957212129433,
                    66952907920795799107680981128859636177126243192813793600213942409930561041968,
                    97738630836122651931907371295696926181303516999085767965275756802769103696640,
                    86056786573167414412681166168252960406880608123124193289687215839010289393365,
                    42453213914905194455440404069578264192574453344270898367924206751883339264593,
                    100519484132498123993280827552597641444767528842124397297226835189343039225855,
                    30418746830344061354082449665096536031982034761593207228745631004087660418979,
                    94840054322059291530750321008166965053871351749658110562305809404250112199706,
                    42301955221152678394190333573390831727995145343891343924222537015244996575494,
                    68599396864515883651939550638527607595242626780681277342646949156789742939178,
                    56974666195930694403713290580441264812544914556973432228768127355537336583012
                ],
            ),
        ),
        list![
            
            (
                111946434827258922207533214337541842175192226593200877216295834618633792652802,
                593409582,
                587367660,
                list![
                    12040790018255253175734513070385891264458577851465876860936625204887853284043,
                    99865809026660730312994302880289471985031736066390571629669459464718115527345,
                    88995554626350955378860981084283361291560731884244610333940254954654167069930,
                    17985667570212032649526420570784905529971353612358213550372984872408880387065,
                    89885095617417087437198489921424224025664554684691257572928001555804052215038,
                    99215924517003196972396973610338345201395393836556904540617155425958536317764,
                    18401876500249834491932711762699271007051640770552496964093770770497235480505,
                    50223089930766780648420962905028756868696889295739221059412442121062848103044,
                    105316851875274344497535382207946823589517861462074844933814328311870654607102,
                    90558419880652824662774599022959758016669182953902165289838287488354051391324,
                    111556343781670588905254023372006829452146356493128635618927123084160652957095,
                    42116764288072310070672189276989507429562415039346819313514627634725942212400,
                    73532842762720789267106903508676014702951899518336472895610872065937466577305
                ],
                786239131,
                list![
                    85475504623908101875097113966681555408559933505116277276576624951195740584713,
                    108107397214980313376256773390857464975866136096730579741619284904226576913272,
                    51843581238062463376031129419081532564716131966353584778199098039604241699292,
                    69708238972217748209751425503647928672072008431847602430268807076458131995205,
                    77075551199410743177521475043360903946546791484017068375284472830917757117605,
                    66523985164989991049161367494144013257559507554389272617799946101965178824876,
                    73100625120686294751869213623779358555321217231919006712839046079235728439908,
                    43290136058448504611523123024069582666608226545893721447367329606582546127602,
                    103004083884704634319210563910424111938190889300975410568502348862800487734680,
                    9324707157397250316452383511882720561290835983194440705133352769183646080854,
                    14280810575841645961857793115841251637410386113587664395152174405702209382316,
                    21943457295434020271389422071548966147606711680691687391960551525548151490561,
                    108116531307910424503647974058998454900889561312254412332578839325377658707085
                ]
            ),
                
            (
                14609411070256597378387532347992493223023351766135098876668934012071487472382,
                1838972885,
                866481694,
                list![
                    34254468869835279023252837360651688814880045607676085544421264886260538559340,
                    2455995660616567547647606048288375727805175623380144716323646146393853150370,
                    86500710443303176125052302619977580472039659698206772318800186297810685024141,
                    106901100235598402831667468203039154520874559425432632745101520861992864774446,
                    86519840541751726933968638126339576043752964084343639176899314090358657134969,
                    19512273091390364152327211486843006859922448364050601917488217623543997676084,
                    28659835764751330781137443446356155007484274222058095181842433980539316325627,
                    57635401811692932612507868426892090166100782141577406040991115490076537536011,
                    96501358998471245447557280676713053044770360508881466819327722833532394370033,
                    25881602047818545936140919101288616988490713987796256143649771675817735133469,
                    9262836788191234909055892814380556804465087009926657621218571397512343579420,
                    102146779539805947974236504967555713059736195542450178174944570957989705723401
                ],
                766247514,
                list![
                    48487909074996118653912078806533165234722970972192179193966264803703279039517,
                    4890682140117193538981426915524983865666501688955075854244383983660600526110,
                    44658905651924418446873872463280562088562242277775822842649626092017915651333,
                    86239933761481913442394352591176078325835889899440890639693133675777473631783,
                    21950490827796103860405159893124898211383519932105400806006994578268619607776,
                    1761766374340806222100670298566930784112859236995065952131078249566600740762,
                    3096933944292333379050970096878851938378779690399738919824159749034611319635,
                    78908150743389132637917509186549544313074349491519136966569262876275643091181,
                    6089918512999052149777565829664613515237455400582428956012277403215116404253,
                    93256783018637988834027567481546617869832066232141621910558192661043068696164,
                    84569121054497190859881197455394388889089617204287534961803250205203837259866,
                    100386306058649164977898107900012791789522270657328832254866212677131141143646
                ]
            ),
                
            (
                16187237833258614573159264045276350661232941951731651418567972740608421874183,
                720845053,
                2110295453,
                list![
                    105459649871326042976655718835989570566342480761605143563231648085637569586153,
                    24367524535019883088855794470502162205825703904274194658368557350023784508448,
                    99988259811111081907103405873367054833503289429627839223895305430116066226898,
                    13689855356709205672023158651185670340708426783234968690511699116226027157990,
                    95982782918569455297933844654045967754571445093074350319484601120817546036328,
                    44546614447211928033505310481578811711442511890184732542025461395844498861235,
                    75810605306176285793004254519121241442611794500925345866354590163622064655989,
                    25328509874278904253612308273744502035740901389337292354449453843475819162803,
                    108721855573552170043724565991167439834017795757497444138080476381092600916396,
                    95962890942359110276312135256252168079439631687240979921179305893342730662939,
                    69648837543493228761353596820873427850318265928400066921816467739657143210617
                ],
                2323250297,
                list![
                    69061178997723779099426388016938725789514598435166138654907236439041950126033,
                    71217628697061442324722445856272305620000011788490077062486544577168096579620,
                    108201065231202844097119550247152407340635948928992708141445333377445165215736,
                    109249674131550953303904571722086796993156465863440155892614355134290388030955,
                    51151530308750420354045984858904228344376855540169447177094224499829917415655,
                    59067646531411016984330054806463391915484460020518474804789433244988857745716,
                    65864688882842564655952465510371616623802581378070322891242506888961471446859,
                    21451415381883982013218108226946310497658093331823989853714715200882923663826,
                    31896581452160083365145724811162485343714706893649839337200240132156161147751,
                    70653227989702850214902520938791853959653997875066665376945147991022913250747,
                    12764200682137467477510613160967531054197068385553155047372517506302699406566
                ]
            ),
                
            (
                73544147395337689004430467629315209559681614627067346301810556415192743581500,
                1755652062,
                100998558,
                list![
                    10522927000172222242134135934491970161379083573361607760781767809684540155979,
                    26957871867182316404884602441288751673277521185760995139313658741081571851297,
                    81689743533021018403584717492986541935992521944762019268513812797720821914132,
                    41143961695496747971620559664084575594114769923665584814197154047860831244273,
                    80677239322218686305037656018537625487908546001543840870746190603318155822162,
                    115529944276276185847268495279512564554956996367178964781316488416000667461515,
                    84573985869756654123687959572877650994112905845867700219732604963645153047948,
                    50730505057918649688908430979795513593873813003871235841535870452900031908980,
                    65314323438201857632125201637864451072734282239204242644566440367975449679380,
                    70025665468674581662679866329236654680448349358128881261637621466176617333405
                ],
                2844257186,
                list![
                    11433134349705652090941462765660199972148736653804050321394558241735177895945,
                    52197173786489139816840792122368090657593934654903855876955737474464864828657,
                    15542080882193130585364335705279108055406338978665065896497466691199240506720,
                    103875264190988466438653163924432309754959732652610752210568909474689998847140,
                    50182701118405480609014742583209180137409406403614682183413976158312297539123,
                    89091983803099281835630851063494572331457468630429323083631959475557221156076,
                    74202149920304922733799901383198665237718352491781492172857702340906743711532,
                    61294256399166423573950684954742179040932245154177277983426578235700654787552,
                    35278632189060327813360306580951488545016276586784895550037392850356144539476,
                    89425822023787115004997529614203966725509035503824782859167290849363318923711
                ]
            ),
                
            (
                15724229312219948954954512583504467882983404941165832610262898233590117033594,
                1994040583,
                2746377956,
                list![
                    115276898556503077720600292709914997861041560996610129242944806124688730168881,
                    6093143809192100245275021481956717349242746668419189345382211945598226608915,
                    103606521509434540331286849423615912052124402423990891999388838176598715140503,
                    109786406468056927268923631987035186238790666149610708345759666774046747778219,
                    8812746990970658068586150207019311691212860129858260153190674659258384117491,
                    91296754249134600224318536722794221157495396941605235377473597279708496585540,
                    38175389610248119404303309751548453291559859914666765712809322175917236454783,
                    6268028930003591082046005795017276593383134983163549078755775694769548882466,
                    83677109099360921584226154686720249543501031701562006319680595592535157104619
                ],
                2830711275,
                list![
                    75433860686235592477946241508851238298315946430742082153077349590051102539091,
                    97939598010308272696187554271205891440900607216437383928652814859296145325806,
                    22667407203339298550884506570714813705048724651015128943598995698227384516002,
                    72653901915632006053469017988715900572546993656684541520569566615578135756898,
                    111778801183959689112105417986644925867305162212813774306507105110854535517223,
                    2009690565543707621244481740591819149777788652596756461308233578974805658774,
                    41228584614316032976895809718437489158952140278181001098793534957609457333349,
                    2639315109910503020876975599521892511816191183584891236269609268687696561294,
                    107760691204997306998719828293681288190450186649764277291571152238428551135897
                ]
            ),
                
            (
                17738437910730036923927185422057906728211125170085170242151265136234594255630,
                1151636718,
                1336195619,
                list![
                    111771741495811437260429208320254538009690570241870575325300133759153481054700,
                    94518202115809600374409575151972480864922437701436356772984682295070380269049,
                    4353923673198005860512014001897500780946033406349764302101472264379827520691,
                    24930882184510555638275976109136766923893034360151725849458914273249643965740,
                    61436260563790025874891097220804885867011988502776541773691014013435696043525,
                    49537536215569390907647837528933254366278755083115709211479541066165185183875,
                    51713619779655332107569403913051352623015115147843660938286841368454181037343,
                    109494186093398839053966362934132388865504790358380231206661027898967232968414
                ],
                935631459,
                list![
                    66470548389842757009338330267459234512228693613398804941436149045031706652102,
                    39268465766117125056205058536307124655690905297263653334492990263306609402269,
                    12116303626695615528525181374634230686394148156574973918908283024707381199489,
                    96763739937145783928066089196896111075797760506668180012800800170542726532832,
                    5684130339994052258633510450637912658636466048699520369016169697980654152032,
                    108115148117444036354308272061544440362051762537390941819781213192709010809856,
                    88018235343773427471995655888229641676849184989192642912724466548299125222491,
                    82302166834912850032824134185356574441529042942116214962854850446485106909922
                ]
            ),
                
            (
                45414240831122634981114974407216132319985725114217189998139454326440586470300,
                2350631655,
                3179070245,
                list![
                    71266889389450885725689207504793011602403893543187912144193430230342474810106,
                    100643569082303582291148174378614979352886471836424667421580254330547286421381,
                    94789374007154454683936953719021280123126297285734052144326933073778126921091,
                    93701223406023668809846948693935475199240336330086343715801873146693936303365,
                    12114051991455136344949530869778510151501324475818301858644468058539592885176,
                    23464261331676609297197596937965653711958638069188879694379440497203484000705,
                    22760051107696355366671880377357370286747171747223149559195553311120968888666
                ],
                424162226,
                list![
                    100976301860660066983886396117496260182656328576280129625285217292515737829000,
                    106374602351133148442629118290682821382113421222882713977266204605281713147847,
                    32551072047705122837104041429816573407478601999886111339409963839009523864352,
                    76813748425417572444388631742522211036548784297990159240866438028297131288637,
                    30938528418083835661967977571984079100982372138820626506343598815129025751867,
                    10057107487535888407414967740830101238942900721869126149073084722043127091512,
                    79511809662151950007613518022242223738579466770786727006759777478361557155599
                ]
            ),
                
            (
                86593030678223703421651047821545416377485176882670647333545017246111918712745,
                2438179415,
                2863970937,
                list![
                    11553042633572810402574040393234914956674178586103032114318820294035096794545,
                    84291548807521865717103476307249472699998916953848431814604977184852548276432,
                    19372047403938930271932887856946234639806163063081470124421556333956694864781,
                    88237396310117554139994877956091804011412778575343674693932044401178268836580,
                    81778823558778029378670561145851328337015370450984626282281987452396742712824,
                    76165052397842229918188138898358370362921459811096809526792798516395294113945
                ],
                2399555484,
                list![
                    89767347007063253625933130825061532642563260654817145907884126227491341307141,
                    29244866152142887264364422208615252002225008512460291567846611634397452433252,
                    94353429424431820197183391250140204088140924203488465630730580492612043861627,
                    37110737659613231831070619684263815956252757794910113848995652187029264066206,
                    16928479464306232457685844023604629457984378537995740314611427692128789757910,
                    41400117452279044837254698405379351032900690556019062813943866616947701016076
                ]
            ),
                
            (
                81486635216770259806928363191566725559166199191715651782449064474797352482260,
                259430084,
                521794749,
                list![
                    72418846322028530266142440605540449815411771038783377330624912527549392049508,
                    102986149378410153736155896478822325344368617034181811673208806957258928841750,
                    76015507601107096866110491477669768524621354017195152372977016028884850836061,
                    40986539876363569655221039429599920017023576775530832194470907308942715296265,
                    3531409345126854725106386585806242960815835671510496940623029353855446561638
                ],
                1047855380,
                list![
                    49305225433962049523666209587611782209610577702010047177368146845015909126736,
                    3017193477556530476794018655910036129277911496937709156895690613252319373986,
                    30807286310018087316766974309019149018147659211684327012159901667465045496861,
                    72279970915063344646676005679458309269555515713015966397830321203512815503114,
                    58431110636763261638082317470725828768732821109033871250453524437997181558328
                ]
            ),
                
            (
                2602135856068406767876326370940493454803525596065452959785412916693689963469,
                2273092189,
                1949237427,
                list![
                    104771388893868580275729630901604357155125848608676900677252540685411567123456,
                    105603363799278209301738033757462959944084064442638041680396759245920642270646,
                    817695418428380358708407999256171861017681281594182195503626020942982425253,
                    90172877730879475162581330193883411947623444707917800039947910590666800578054
                ],
                1175513064,
                list![
                    65085212943756489100475924928174986746980361214705754405804886135805048244406,
                    8837390850018974813073584519019117192326322855459562693310074371176763916674,
                    65445048175795202470103763420740928400335322712606375689839486737791507108061,
                    41055796356862930404048357492327774205021281500772600275213987342857774512496
                ]
            )
        ],
        (
            82254079243737864540513136685540892552796163938457282561301990170133914440615,
            2133065320
        )
    );
    verify_proof(proof);
}
