// SPDX-FileCopyrightText: 2025 StarkWare Industries Ltd.
//
// SPDX-License-Identifier: MIT

//! STARK verifier for the Fibonacci squared AIR.

#include "channel.simf"
#include "fri.simf"
#include "air.simf"
#include "field.simf"

/// STARK proof for the Fibonacci squared AIR.
/// - Merkle root of the trace polynomial evaluation on extended domain
/// - Evaluations of the trace polynomials in the sampled point, together with the corresponding Merkle proofs.
/// - FRI decommitments
/// - Last FRI layer: Merkle root and free term
type FibSquareProof = (u256, FibSquareEvals, List<FriLayer, 32>, FriLastLayer);

/// Evaluation of the trace polynomial in a given point, together with the corresponding Merkle proof.
type Eval = (u32, MerkleProof32);

/// Verify the proof that we know A_1 such that the Fibonacci squared sequence is correct and has
/// the following boundaries: A_0 == 1, A_1022 == 2338775057.
fn verify_proof(proof: FibSquareProof) {
    let (p_mt_root, evals, fri_layers, last_layer): FibSquareProof = proof;
    // Read Merkle root of the trace polynomial evaluation on extended domain
    let state: ChannelState = sha256(p_mt_root);
    // Read composition polynomial coefficients
    let (state, coeffs): (ChannelState, FibSquareCoeffs) = fibsquare_read_coefficients(state);
    // Read FRI commitments
    let state: ChannelState = fri_read_commitments_32(fri_layers, last_layer, state);
    // Random query
    let (state, idx): (ChannelState, u32) = channel_draw_32(state, DOMAIN_EX_SIZE);
    // Read trace polynomial evaluations in specified point
    let state: ChannelState = fibsquare_read_evaluations_checked(state, evals, idx, p_mt_root);
    // Calculate x given the random query
    let x: u32 = fibsquare_calc_x(idx);
    // Evaluate composition polynomial
    let cp_ev: u32 = fibsquare_compose(x, coeffs, evals);
    // Verify FRI layers
    fri_verify_32(fri_layers, last_layer, idx, x, cp_ev);
}

fn test_verifier() {
    let proof: FibSquareProof = (
        104500214297066916133126671825692285761566746556879834723302550549120383229768,
        (
            (
                3027564753,
                list![
                    78179694392545182856497229932792816513483600446272921784583553218832085655637,
                    75528716201285361130701316090843171215050193839451517741508297955102584256671,
                    106497319650655360692396931604218855192088715537689120241684734949792194223586,
                    13871427221327680874103839507956193301516721188799098696210348344338419265095,
                    16836830127149900280919488550144927335744928320758646920482978036467667779998,
                    41557937716939887237019804052355548670366048032817944016607226559694002243539,
                    112570221409441394852403459986634153610313639486597174578601647048405091495871,
                    66423013082348118732383576298944523788142630479596706877217836290593084525259,
                    104649753038128739602557406606869162489853591910406720094104055421638287293889,
                    12104318348038747146419148887864192680601590157691711429735512534097309433586,
                    31559769642264477476609947789038892249602341113974031028210998883128473984759,
                    59506023094292276557631524570503011981542785608587973088039221793896784114979,
                    84551821149389691654110203871134974088990053182576151018715531676419185584733
                ],
            ),
            (
                1953409283,
                list![
                    58345203285151208561529677642286686048662116104537265439358578069315707494676,
                    74163577712818236838438459336988161834597775878948195424240831876630906582507,
                    36297047352867088984941991576188354640867682713501472730951319139783224612347,
                    36341072364310858391208189187141812564269842317091953472832550764881087156208,
                    16836830127149900280919488550144927335744928320758646920482978036467667779998,
                    41557937716939887237019804052355548670366048032817944016607226559694002243539,
                    112570221409441394852403459986634153610313639486597174578601647048405091495871,
                    66423013082348118732383576298944523788142630479596706877217836290593084525259,
                    104649753038128739602557406606869162489853591910406720094104055421638287293889,
                    12104318348038747146419148887864192680601590157691711429735512534097309433586,
                    31559769642264477476609947789038892249602341113974031028210998883128473984759,
                    59506023094292276557631524570503011981542785608587973088039221793896784114979,
                    84551821149389691654110203871134974088990053182576151018715531676419185584733
                ],
            ),
            (
                1898341013,
                list![
                    24244425287531121942826399392215583802234685903580915376720837432078973407873,
                    55450788671647910356748237604494845384725382489102911850816175439038977420235,
                    73641474932685794850088084650715755110320867034174209469973294093123034106509,
                    101928202518578203142206890198780476746892447837658586586146583515177113202920,
                    1077522212289812393185225653953686017334725584146889959273535872985181936185,
                    8058963540740255471180177993752382845916797419955377658094524724867304742242,
                    112570221409441394852403459986634153610313639486597174578601647048405091495871,
                    66423013082348118732383576298944523788142630479596706877217836290593084525259,
                    104649753038128739602557406606869162489853591910406720094104055421638287293889,
                    12104318348038747146419148887864192680601590157691711429735512534097309433586,
                    31559769642264477476609947789038892249602341113974031028210998883128473984759,
                    59506023094292276557631524570503011981542785608587973088039221793896784114979,
                    84551821149389691654110203871134974088990053182576151018715531676419185584733
                ],
            ),
        ),
        list![
            
            (
                111946434827258922207533214337541842175192226593200877216295834618633792652802,
                593409582,
                923251901,
                list![
                    17540831068560766321052770697550665182025821564863118380897005978610253809052,
                    13490820126768503546713305874201638587182558048552737037928968544000959836578,
                    67640261060310281614617129569832021532378638521015673944051380250585817950589,
                    631412842002912924792425101650964710554489354340215618658733627401455333860,
                    17190394621193799959085831032785213951085350672688112691188556303202643483433,
                    114558971768030770732904207007094407201045380468306285657881558025031752913310,
                    94915218567489956707533823968492848079175606276822399890151930786979691840802,
                    63723845536693145782867568763091798842757890718151800631942757125972242473447,
                    83739232786085284935884126640040569909173812240017237972648720995827030701853,
                    52120088504934144387849016579582963209544551931533451514935659253681790701351,
                    32773104510488342950968782937148931131668239548723343123703557201968423929268,
                    73319588304251641059212019675153659767623115107838903706369158455854470583690,
                    108116531307910424503647974058998454900889561312254412332578839325377658707085
                ],
                2570687424,
                list![
                    14943164906758774721839803752248315925465230051961188132937234226790620782799,
                    24618865185111025764688883839342616369197883625220095318631361774054008505267,
                    41004964584775988157876158278758218535258568176189013442087102944499474084482,
                    70155321968237537838562459086453735481504582688714369623815820675218412655511,
                    89915320836972301241108077318952195225107982469604122369262591424738789495563,
                    59823264891701849896961249919954187151551007628077814821216513247746707578991,
                    29662565664495634806651784914566072898534924397630717198861243374502826916000,
                    15889031199955114489885608355360496711088305731664911852428200784253504039725,
                    63979400321971752730936955448947303218538092493653092645948424664977692901272,
                    95041602017282722568209975837529952647669032472614986038240299865116362202400,
                    115119397108505623168828353423881372087140343247218063503851481587896738449344,
                    62446942441231252897306038221178557425109007815200075633365040296042166523534,
                    73532842762720789267106903508676014702951899518336472895610872065937466577305
                ]
            ),
                
            (
                14609411070256597378387532347992493223023351766135098876668934012071487472382,
                1838972885,
                693298329,
                list![
                    78491912135766403184622051977435838809506325973125777990389661261964385912268,
                    5745526991056831581738116749025901311572583528641770296332486767443532257923,
                    44079596871458445639990827549591526405953904311305944033003715642024758371437,
                    32974522997053527666152612410124243850180674605824427433145670331753474358374,
                    42373064399461727469765904879063839523585922968756644758629338830365480293873,
                    28676055506314866889336751494423817206378750503367342706608310704539687883646,
                    112546033886878990837721289889315523542084117160768175263869116617226574068312,
                    93914568075690008161158838823833418377027049187750343579546690848474845494161,
                    70373194122680381921155846877656090631438281046451625443039530361664418468319,
                    93256783018637988834027567481546617869832066232141621910558192661043068696164,
                    84569121054497190859881197455394388889089617204287534961803250205203837259866,
                    100386306058649164977898107900012791789522270657328832254866212677131141143646
                ],
                1447279113,
                list![
                    49348951420692858427955988899070732277305656487519980886428540616018716420763,
                    97034660655685877630492303345250132589700169911816319942081356178505392963525,
                    80978119339570435132669991059634902519506375602298312485596922250790225346224,
                    88633945906109978731479806265755823401450381075961361011452956564862998612978,
                    35902442539357006883810381745985511334163196103743808933359984390443281132917,
                    60459187387293832047131694866467212798381216179884404775178313841584070811639,
                    6293559584674228226719841777945621027862808513291042020353560058006019800366,
                    71591367482855856395133632884807018074800254631618329092741994002352946564791,
                    19655825828927317984626842259225102249768030290931472138789109090408312288718,
                    25881602047818545936140919101288616988490713987796256143649771675817735133469,
                    9262836788191234909055892814380556804465087009926657621218571397512343579420,
                    102146779539805947974236504967555713059736195542450178174944570957989705723401
                ]
            ),
                
            (
                16187237833258614573159264045276350661232941951731651418567972740608421874183,
                720845053,
                2624281989,
                list![
                    57407799071571244598429396847201479905704581656558714322679614274541246256622,
                    83339348579252619048873378887593570746455702808730864365084699995397193164003,
                    37372335315280307174986152161874144337736606703404667603372032782953632599180,
                    45705820787814428905882748276715251719808010593804592603141157652719132892422,
                    111782644460371694636987636683095614909333195304779417614879162491826310084327,
                    3382297770808529819888255365837215277532272820281281855140738019143258135567,
                    5938843823729129666486498651026506348398892692751413804692763340592810599637,
                    395066528632582410673355764837529634111701195604839000834240032019146501813,
                    46672787677880026548629417536407166725725724761166276577342498859983263725628,
                    95962890942359110276312135256252168079439631687240979921179305893342730662939,
                    69648837543493228761353596820873427850318265928400066921816467739657143210617
                ],
                768085777,
                list![
                    113399500549924957825665304588911419298820362863229016454575538445303551414230,
                    61957581295542765576846967037106983292785476184856134015936807323115257638982,
                    115515275460156623989306938306109271979483215997800745775177824559351566574796,
                    91731168607312037461732597910282130572025451795276746598562203916315090052106,
                    7308693640562524739600387054927287864883874339748658997302871321665259815152,
                    16824576298950152377797292794602693280163897863675214364024992813162569003923,
                    68486483654793122104191644361430558607501880913006070912209225498859324454500,
                    45858432449842093011728150525478544566407908705932480024132398936316750272104,
                    112431814178712292488854787562756654934902662788220684935848275712360703096604,
                    70653227989702850214902520938791853959653997875066665376945147991022913250747,
                    12764200682137467477510613160967531054197068385553155047372517506302699406566
                ]
            ),
                
            (
                73544147395337689004430467629315209559681614627067346301810556415192743581500,
                1755652062,
                1113677667,
                list![
                    16517049831522501014600454963488312047673066604102047921733257353300806691708,
                    26858361213236893048623535499153972143401254877208101885988900513972407620164,
                    3273147540319056701005458545254341124507121010086681264570651745757184172770,
                    32704145643877095307284052670683567176424095034345689879835691539459771382068,
                    75599314794483646402474018927769752099931531659412608186585236485594069421042,
                    33615499634441115903564264814994544627981212043724557095032612286338629802888,
                    21803846900432797877934376938394643684418900100741884553741078912103336818390,
                    97938820191726658702117269462663470956085821650391780994433865031611505296722,
                    51858889079961886084377384029917755555028680842564365541217251737794697113484,
                    70025665468674581662679866329236654680448349358128881261637621466176617333405
                ],
                2429380509,
                list![
                    15740306006809241647607204223338255438643196837562010944321225841868427967296,
                    81717304769936580353842837069272131286697585003928593382654805888855772658471,
                    53164432103848262967232544970186582073493963051634547331892790236068679532277,
                    58188812957125165370463424166396177809135506366247052225742762111024182365588,
                    75131446654301622822983118813171668572485127946665342846123200802413343618519,
                    27168889445090949828217626472647246674354521308728359274141493492597358281995,
                    12734078335413542230100598432248334049993349202417944067143586738178016849898,
                    49014735263717969391160630102647819739920469532758687075797943124049176163890,
                    3106396235451546678333456011344047220303822244430415407434439065471443391006,
                    89425822023787115004997529614203966725509035503824782859167290849363318923711
                ]
            ),
                
            (
                15724229312219948954954512583504467882983404941165832610262898233590117033594,
                1994040583,
                658584827,
                list![
                    72683578131848056279232732778987279448156089079076294443597756117586404721393,
                    16092806822163020506248152988048182442425870019761479769809423784484996508099,
                    5813633211475740464160221331322858968451039573748480101684691451930883294585,
                    38530896918319059580535212036396242683462125362518356614900471324042996308501,
                    65453928910461961353147419283533212017598138620274543382222188379589575808369,
                    86962370187758545277079727617129407779284081134036127429439770488766298979948,
                    2665000410336978579513292151800048166676697918781437212648523787964645970520,
                    2639315109910503020876975599521892511816191183584891236269609268687696561294,
                    107760691204997306998719828293681288190450186649764277291571152238428551135897
                ],
                3056517846,
                list![
                    52101092406117409848219338932182748039627914616573928404601421867483000491225,
                    52575097351234980516374579981750146004283288627826353689640467658191229279753,
                    32599923060339475568562173485794947382006916938812584309857255606587196978773,
                    63672383792039445201961756696653093241586390540467178772621327363143994239619,
                    62003216548476659686381114050784111060542274880278959174894696804550425593884,
                    73336140208278081914679858443186406837796963193297663598265372818527834254081,
                    36947705441628498168206671874221362403712974591567900281882334025052844645165,
                    6268028930003591082046005795017276593383134983163549078755775694769548882466,
                    83677109099360921584226154686720249543501031701562006319680595592535157104619
                ]
            ),
                
            (
                17738437910730036923927185422057906728211125170085170242151265136234594255630,
                1151636718,
                3134572010,
                list![
                    65218032909634764366371956289014571839733582845028217383770002841933432114472,
                    73477482317703795002817275443882162063537675902428982729024450409461481948254,
                    71419056704262638797104434894715932077120019036225437372646694398618736099132,
                    42015725397778187308987783233293096167142721488880025493774505379373885384442,
                    26885194750986002569403104394989309482213513418364732038257598853931123572330,
                    39842020945757860679939201219105690124276983243618393355274231378131163258998,
                    2604220410869528046996236025791995942686207453419580024713132306629697434728,
                    109494186093398839053966362934132388865504790358380231206661027898967232968414
                ],
                2654000456,
                list![
                    89527310869785542345920739536277531286992396558638850931940189749537269131137,
                    74842901725665271890724481092097977501920496164358020937303680615961953490904,
                    19443783743160269270786176883518703781234705385817635795471225415182206593169,
                    5715078280582624505409945084812136743260034349196879028738794322474355118631,
                    59902874297484075580448876165362250864542771923221979521766025497085612820431,
                    67063012661486143769050280407659892850069340652403225082161338275333979983542,
                    11528324114979006410701710434099858109422588343868857874355995380697174419488,
                    82302166834912850032824134185356574441529042942116214962854850446485106909922
                ]
            ),
                
            (
                45414240831122634981114974407216132319985725114217189998139454326440586470300,
                2350631655,
                385023159,
                list![
                    13237321081252763952203255834605552032537294159297657057229539203298211345977,
                    27098099625060163401135980366571663190914543240827636281301851221785117537104,
                    27206939945204259111541410848135244935867168172363964242742228626984180713390,
                    71506171207488696882166372230505125191424230577898726062797033530374484722322,
                    26829822806471040795538110977737081120982738156334289892999757583140400083075,
                    82043432833859917700364219591696309664292344952914371462782656889068365641873,
                    79511809662151950007613518022242223738579466770786727006759777478361557155599
                ],
                1451067072,
                list![
                    100362152657708687657717834763632127885464718207858997393578378777666665118464,
                    20997468706540830932890558677618887257605838113867269045512771783002252605639,
                    113888660772024364638682301672096843964443804635032518055829407217175951755284,
                    92809864205654693713309826546597356278881833766780453385445815695052413972153,
                    26168514552767525151635688799615511526983145376899865594954263144577874520229,
                    101211203829292083810756373568099014512583947761832080912746931289374803503259,
                    22760051107696355366671880377357370286747171747223149559195553311120968888666
                ]
            ),
                
            (
                86593030678223703421651047821545416377485176882670647333545017246111918712745,
                2438179415,
                2720175192,
                list![
                    643413290959422927586726299010932065839501004155332570792932729066685655664,
                    21561969776101644231190614874284262387682065169968092680455813304483901331104,
                    85677288221661507363218211825229356689871220994888486063622499781634133091744,
                    41871093658038179268222948624479822188120500619697575444408157634518428221134,
                    115384980305833795936068903357670403063101836947782974871248411487588179840982,
                    41400117452279044837254698405379351032900690556019062813943866616947701016076
                ],
                452618279,
                list![
                    59893568427663120957536990110316710948350256420420009803292510988918551919736,
                    111530457312794424583888472679074516480920520863274646163634164173749157170416,
                    53307239579196367019119358954091305653722142686833674009766547104992002204619,
                    68933542761926008327999374978570171027154183961727551177934297242118667536597,
                    114300793671860875306951948529412604173430956988398714403685972655924743956794,
                    76165052397842229918188138898358370362921459811096809526792798516395294113945
                ]
            ),
                
            (
                81486635216770259806928363191566725559166199191715651782449064474797352482260,
                259430084,
                658927437,
                list![
                    19318940360813223581977209796768996452979348645146754350477129892654506558829,
                    19376403568516565604192060120793834028435353213177835927972438890331357312959,
                    77363115410185596117788840398905404025526806334951715468047533986824323058374,
                    46187728818650539637755121459565094307591438867360994468673950832034067552493,
                    58431110636763261638082317470725828768732821109033871250453524437997181558328
                ],
                1641928685,
                list![
                    27615898053415472464425985291862243760409451151300492019321050641479833992357,
                    74141753905672656757662065920336133259188337837138683935920163087629063168224,
                    78382459455299988184746273845884424858500278188602912761903292648764736710878,
                    31254224035190358677171356634830230222511147775138292740077029706583340395839,
                    3531409345126854725106386585806242960815835671510496940623029353855446561638
                ]
            ),
                
            (
                2602135856068406767876326370940493454803525596065452959785412916693689963469,
                2273092189,
                1251305153,
                list![
                    37594613418733288605919156060969250527957214078046456689711964741118384376351,
                    80964007339239488016279179956691670412044946620023572621687690989305747699468,
                    77871036458790620267354093329136468779664617915568876151297961081025262359837,
                    41055796356862930404048357492327774205021281500772600275213987342857774512496
                ],
                1873445338,
                list![
                    27455750522982303216300236170000759602447422370063584887813657296717309813824,
                    5965164490025877506357645212867106766992722300107955061496272753764679821439,
                    105623462990254858147137603646571540444126514139168133303981262725435984720890,
                    90172877730879475162581330193883411947623444707917800039947910590666800578054
                ]
            )
        ],
        2133065320
    );
    verify_proof(proof);
}
